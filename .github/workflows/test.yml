name: Test Transaction Workflow

on:
  push:
    branches: [main, develop]
  pull_request:
  workflow_dispatch:  # Manual trigger for testing

jobs:
  test-single-job:
    name: Test Single Job Transaction
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Lint
        run: npm run lint

  # Integration test - uses the actual actions
  test-transaction-integration:
    name: Test Transaction Integration
    runs-on: ubuntu-latest
    needs: test-single-job
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build actions
        run: npm run build

      - name: Create test spec
        run: |
          cat > tx.yaml << EOF
          transaction:
            id: integration-test
            mode: strict
            state:
              path: tx-state.json
          EOF

      - name: Start transaction
        uses: ./action/start
        with:
          spec: tx.yaml

      - name: Execute step 1
        uses: ./action/step
        with:
          id: step-1
          run: echo "Step 1 executed"
          compensate: echo "Step 1 rolled back"

      - name: Execute step 2
        uses: ./action/step
        with:
          id: step-2
          run: echo "Step 2 executed"
          compensate: echo "Step 2 rolled back"

      - name: End transaction
        uses: ./action/end

      - name: Verify transaction completed
        run: |
          if [ ! -f tx-state.json ]; then
            echo "❌ State file not found"
            exit 1
          fi
          echo "✅ Transaction completed"
          cat tx-state.json

