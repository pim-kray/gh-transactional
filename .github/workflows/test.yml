name: Test Transaction Workflow

on:
  push:
    branches: [main, develop]
  pull_request:
  workflow_dispatch:  # Manual trigger for testing

jobs:
  test-single-job:
    name: Test Single Job Transaction
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Lint
        run: npm run lint

  # Simple integration test without multi-job complexity
  test-transaction-basic:
    name: Test Basic Transaction Flow
    runs-on: ubuntu-latest
    needs: test-single-job
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Create test spec
        run: |
          mkdir -p .test-tx
          cat > tx-test.yaml << EOF
          transaction:
            id: test-basic
            mode: strict
            state:
              path: .test-tx/state.json
          EOF

      - name: Test start action (init transaction)
        run: |
          cd action/start
          npm ci || true
          npm run build || echo "Build action manually"

      - name: Verify state file created
        run: |
          if [ ! -f .test-tx/state.json ]; then
            echo "❌ State file not created"
            exit 1
          fi
          echo "✅ State file exists"
          cat .test-tx/state.json

